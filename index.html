<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MindFlow - æœ¬åœ°åŒ–è§†è§‰æ€ç»´å¯¼å›¾</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <link rel="stylesheet" href="css/style.css">

    <!-- æœ¬åœ°åº“å¼•ç”¨ -->
    <script src="js/lib/d3.v7.min.js"></script>
    <script src="js/lib/localforage.min.js"></script>
    <script src="js/lib/marked.min.js"></script>

    <style>
        /* [æ–°å¢] æ›´æ–°æç¤ºæ¡æ ·å¼ */
        #update-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #333; color: white; padding: 12px 20px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 3000;
            display: flex; align-items: center; gap: 15px; opacity: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #update-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        #reload-btn {
            background: #667eea; border: none; color: white; padding: 5px 12px;
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px;
        }
        #reload-btn:hover { background: #5a67d8; }
    </style>
</head>
<body>

<input type="file" id="importInput" style="display: none;" accept=".json,.mindflow">

<!-- [æ–°å¢] æ›´æ–°æç¤ºæ¡ç»“æ„ -->
<div id="update-toast">
    <span>å‘ç°æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦æ›´æ–°ï¼Ÿ</span>
    <button id="reload-btn">ç«‹å³åˆ·æ–°</button>
</div>

<div class="app-container">
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar closed" id="sidebar">
        <div class="sidebar-header">
            <div class="brand">MindFlow</div>
            <div class="project-control">
                <select id="projSelect" class="project-select">
                    <option value="" disabled selected>æ­£åœ¨åŠ è½½...</option>
                </select>
                <div class="btn-group-mini">
                    <button class="btn-icon" title="å¯¼å‡ºåˆ°æœ¬åœ°ç£ç›˜" onclick="app.data.triggerSaveDisk()">ğŸ’¾</button>
                    <button class="btn-icon" title="ä»ç£ç›˜æ‰“å¼€é¡¹ç›®" onclick="app.data.triggerOpenDisk()">ğŸ“‚</button>
                    <button class="btn-icon danger" title="åˆ é™¤å½“å‰é¡¹ç›®" onclick="app.ui.confirmDeleteProject()">ğŸ—‘ï¸</button>
                </div>
            </div>
        </div>

        <div class="sidebar-content">
            <div id="resList" class="res-list tree-view">
                <div class="empty-tip">æš‚æ— èµ„æº</div>
            </div>
        </div>

        <div class="sidebar-footer" style="display:flex; gap:5px;">
            <button class="btn-secondary" style="flex:1;" onclick="app.data.createFolder()" title="æ–°å»ºæ–‡ä»¶å¤¹">ğŸ“ æ–‡ä»¶å¤¹</button>
            <button class="btn-primary" style="flex:2;" onclick="app.ui.openResModal()">+ æ·»åŠ èµ„æº</button>
        </div>
    </div>

    <!-- ä¸»ç”»å¸ƒåŒºåŸŸ -->
    <div class="main-area">
        <div class="toolbar">
            <button class="tool-btn" onclick="app.ui.toggleSidebar()" title="åˆ‡æ¢ä¾§è¾¹æ ">â˜°</button>

            <input type="text" id="projTitleInput" class="project-title-input"
                   placeholder="æœªå‘½åé¡¹ç›®"
                   onchange="app.data.renameProject(this.value)"
                   title="ç‚¹å‡»é‡å‘½åé¡¹ç›®">

            <div class="divider"></div>
            <button class="tool-btn primary" onclick="app.graph.addRootNode()">ğŸ¯ æ ¹èŠ‚ç‚¹</button>
            <button class="tool-btn" onclick="app.graph.resetCamera()">ğŸ” å½’ä½</button>

            <div class="spacer"></div>

            <div id="saveStatus" class="status-text">å°±ç»ª</div>
            <button class="tool-btn" onclick="app.storage.forceSave()" title="ä¿å­˜åˆ°æµè§ˆå™¨æ•°æ®åº“">â˜ï¸ ä¿å­˜</button>
            <button class="tool-btn danger" onclick="app.graph.clearAll()">ğŸ—‘ï¸ æ¸…ç©º</button>

            <div class="divider"></div>

            <a href="https://astroite.com/article/2eh5d6so/" target="_blank" class="tool-btn" style="text-decoration: none; color: #667eea;" title="æŸ¥çœ‹ç”µå­è¯´æ˜ä¹¦">
                â“ è¯´æ˜ä¹¦
            </a>
        </div>

        <div class="canvas-wrapper" id="canvasWrapper">
            <canvas id="mainCanvas"></canvas>
        </div>
    </div>
</div>

<!-- å¼¹çª—ç»„ä»¶ä¿æŒä¸å˜ -->
<div class="modal-overlay" id="resModal" style="display: none;">
    <div class="modal-box">
        <h3 id="resModalTitle">æ·»åŠ èµ„æº</h3>
        <div class="form-group">
            <label>ç±»å‹</label>
            <select id="resType" class="form-input" onchange="app.ui.toggleResInput()">
                <option value="image">ğŸ–¼ï¸ å›¾ç‰‡ (Image)</option>
                <option value="md">ğŸ“ æ–‡æ¡£ (Markdown)</option>
                <option value="code">ğŸ’» ä»£ç æ®µ (Code)</option>
                <option value="color">ğŸ¨ è‰²å¡ (Palette)</option>
                <option value="audio">ğŸ¤ éŸ³é¢‘ (Audio)</option>
                <option value="link">ğŸ”— é“¾æ¥ (Link)</option>
            </select>
        </div>
        <div class="form-group">
            <label>ä½ç½® (æ–‡ä»¶å¤¹)</label>
            <select id="resParentId" class="form-input"><option value="">(æ ¹ç›®å½•)</option></select>
        </div>
        <div class="form-group">
            <label>åç§°</label>
            <input type="text" id="resName" class="form-input" placeholder="è¾“å…¥èµ„æºåç§°">
        </div>
        <div class="form-group dynamic-input" id="groupFile">
            <label id="fileLabel">é€‰æ‹©æ–‡ä»¶</label>
            <input type="file" id="resFile" class="form-input">
            <small style="color:#666; font-size:12px;">æ–‡ä»¶å­˜å‚¨äºæœ¬åœ°æ•°æ®åº“ï¼Œå»ºè®®æ§åˆ¶å¤§å°ã€‚</small>
        </div>
        <div class="form-group dynamic-input" id="groupText" style="display: none;">
            <label id="textLabel">å†…å®¹</label>
            <input type="text" id="resTextInput" class="form-input" placeholder="https://..." style="display:none;">
            <textarea id="resTextArea" class="form-input" rows="6" placeholder="åœ¨æ­¤è¾“å…¥å†…å®¹..." style="font-family: monospace;"></textarea>
        </div>
        <div class="form-group dynamic-input" id="groupColor" style="display: none;">
            <label>é€‰æ‹©é¢œè‰²</label>
            <div style="display:flex; align-items:center; gap:10px;">
                <input type="color" id="resColorInput" style="width:50px; height:40px; border:none; padding:0;">
                <span id="resColorValue" style="font-family:monospace; font-weight:bold;">#000000</span>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-text" onclick="app.ui.closeModal('resModal')">å–æ¶ˆ</button>
            <button class="btn-primary" onclick="app.data.saveResource()">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="node-menu" id="nodeMenu" style="display: none;">
    <div class="form-group">
        <label>èŠ‚ç‚¹åç§°</label>
        <input type="text" id="nodeLabel" class="form-input">
    </div>
    <div class="form-group">
        <label>å…³è”èµ„æº</label>
        <select id="nodeResSelect" class="form-input"></select>
    </div>
    <div class="menu-actions">
        <button class="btn-primary small" onclick="app.data.saveNodeEdit()">ä¿å­˜</button>
        <button class="btn-danger small" onclick="app.data.deleteNode()">åˆ é™¤èŠ‚ç‚¹</button>
    </div>
</div>

<div class="toast" id="toast"></div>

<script src="js/app.js"></script>

<!-- [æ–°å¢] å¢å¼ºç‰ˆ SW æ³¨å†Œä¸æ›´æ–°é€»è¾‘ -->
<script>
    if (window.innerWidth < 768) {
        document.getElementById('sidebar').classList.add('closed');
    } else {
        document.getElementById('sidebar').classList.remove('closed');
    }

    if ('serviceWorker' in navigator) {
        let newWorker;

        // æ˜¾ç¤ºæ›´æ–°æç¤ºæ¡
        function showUpdateBar() {
            const bar = document.getElementById('update-toast');
            bar.classList.add('show');

            document.getElementById('reload-btn').addEventListener('click', () => {
                bar.classList.remove('show');
                if (newWorker) {
                    // å‘Šè¯‰æ–° SW é©¬ä¸Šæ¥ç®¡
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                }
            });
        }

        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(reg => {
                // 1. æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç­‰å¾…æ›´æ–°çš„ worker
                if (reg.waiting) {
                    newWorker = reg.waiting;
                    showUpdateBar();
                    return;
                }

                // 2. ç›‘å¬æ–°çš„ worker å®‰è£…è¿‡ç¨‹
                reg.addEventListener('updatefound', () => {
                    newWorker = reg.installing;
                    newWorker.addEventListener('statechange', () => {
                        // å¦‚æœå®‰è£…å®Œæˆä¸”å½“å‰å·²æœ‰ controller (è¯´æ˜ä¸æ˜¯ç¬¬ä¸€æ¬¡å®‰è£…)
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            showUpdateBar();
                        }
                    });
                });
            });

            // 3. å½“ controller å˜åŒ– (æ–° SW æ¿€æ´») æ—¶ï¼Œè‡ªåŠ¨åˆ·æ–°é¡µé¢
            let refreshing;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                window.location.reload();
                refreshing = true;
            });
        });
    }
</script>
</body>
</html>