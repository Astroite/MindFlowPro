<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MindFlow - 本地化视觉思维导图</title>

    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/style.css">

    <script type="module" src="js/app.js"></script>

    <script src="js/lib/d3.v7.min.js"></script>
    <script src="js/lib/localforage.min.js"></script>
    <script src="js/lib/marked.min.js"></script>
    <script src="js/lib/purify.min.js"></script>
</head>
<body>

<input type="file" id="importInput" style="display: none;" accept=".json,.mindflow">

<div class="app-container">
    <div class="sidebar closed" id="sidebar">
        <div class="sidebar-header">
            <div class="brand">MindFlow</div>
            <div class="project-control">
                <label for="projSelect"></label><select id="projSelect" class="project-select">
                <option value="" disabled selected>正在加载...</option>
            </select>
                <div class="search-box">
                    <span class="search-icon">🔍</span>
                    <label>
                        <input type="text" class="search-input" placeholder="搜索资源..." oninput="app.ui.filterResources(this.value)">
                    </label>
                </div>
                <div class="btn-group-mini">
                    <button class="btn-icon" title="导出到本地磁盘" onclick="app.storage.triggerSaveDisk()">💾</button>
                    <button class="btn-icon" title="从磁盘打开项目" onclick="app.storage.triggerOpenDisk()">📂</button>
                    <button class="btn-icon danger" title="删除当前项目" onclick="app.ui.confirmDeleteProject()">🗑️</button>
                </div>
            </div>
        </div>

        <div class="sidebar-content">
            <div id="resList" class="res-list tree-view">
                <div class="empty-tip">暂无资源</div>
            </div>
        </div>

        <div class="sidebar-footer">
            <button class="btn-secondary" style="flex:1;" onclick="app.ui.handleCreateFolder()" title="新建文件夹">📁</button>
            <button class="btn-primary" style="flex:3;" onclick="app.ui.openResModal()">+ 添加资源</button>
        </div>
    </div>

    <div class="main-area">
        <div class="toolbar">
            <button class="tool-btn" onclick="app.ui.toggleSidebar()" title="菜单">☰</button>
            <div class="divider"></div>
            <button class="tool-btn primary" onclick="app.graph.addRootNode()" title="添加根节点"><span>🎯 根节点</span></button>
            <button class="tool-btn" onclick="app.graph.resetCamera()" title="视图归位"><span>🔎 归位</span></button>
            <button class="tool-btn" id="btnToggleLinks" onclick="app.ui.toggleCrossLinks()" title="显示/隐藏飞线 (Alt+L)"><span>👁️ 飞线</span></button>
            <div class="divider"></div>
            <input type="text" id="projTitleInput" class="project-title-input" placeholder="未命名项目" onchange="app.data.renameProject(this.value)" title="点击重命名项目">
            <div class="divider"></div>
            <button class="tool-btn" onclick="app.storage.forceSave()" title="保存到浏览器数据库"><span>☁️ 保存</span></button>
            <button class="tool-btn" onclick="app.ui.exportImage()" title="导出为图片"><span>📷 导出</span></button>
            <button class="tool-btn danger" onclick="app.graph.clearAll()" title="清空画布"><span>🗑️ 清空</span></button>
            <div class="divider"></div>
            <button class="tool-btn" onclick="app.ui.toggleTheme()" title="切换深色/浅色模式"><span>🌗</span></button>
            <a href="https://astroite.com/article/2eh5d6so/" target="_blank" class="tool-btn" style="text-decoration: none; color: var(--primary);" title="说明书"><span>❓</span></a>
        </div>

        <div id="saveStatus" class="status-text">就绪</div>

        <div class="canvas-wrapper" id="canvasWrapper">
            <canvas id="mainCanvas"></canvas>
        </div>
    </div>
</div>

<div id="nodeBubble" class="node-bubble-container" style="display: none;">
    <button class="bubble-btn action-edit" onclick="app.ui.onBubbleEdit()" title="编辑节点">
        <span style="font-size: 16px;">✏️</span>
    </button>
    <!-- [New] 飞线按钮 -->
    <button class="bubble-btn action-link" onclick="app.ui.onBubbleLink()" title="创建连线">
        <span style="font-size: 16px;">🪡</span>
    </button>
    <button class="bubble-btn action-delete" onclick="app.ui.onBubbleDelete()" title="删除节点">
        <span style="font-size: 16px;">🗑️</span>
    </button>
</div>

<!-- [新增] 通用单行输入弹窗 -->
<div class="modal-overlay" id="inputModal" style="display: none;">
    <div class="modal-box" style="width: 360px;">
        <h3 id="inputModalTitle">输入</h3>
        <div class="form-group" style="margin-top: 20px;">
            <label for="inputModalValue"></label><input type="text" id="inputModalValue" class="form-input" placeholder="" autocomplete="off">
        </div>
        <div class="modal-actions">
            <button class="btn-secondary" id="inputModalCancel">取消</button>
            <button class="btn-primary" id="inputModalConfirm">确定</button>
        </div>
    </div>
</div>

<!-- [修改] 现代化资源添加/编辑弹窗 -->
<div class="modal-overlay" id="resModal" style="display: none;">
    <div class="modern-modal">
        <div class="panel-header">
            <h3 id="resModalTitle">✨ 添加资源</h3>
            <button class="close-btn" onclick="app.ui.closeModal('resModal')">×</button>
        </div>

        <div class="panel-body">
            <div class="form-group">
                <label class="panel-label">资源类型</label>
                <div class="select-wrapper">
                    <select id="resType" class="form-input panel-select" onchange="app.ui.toggleResInput()">
                        <option value="image">🖼️ 图片 (Image)</option>
                        <option value="md">📝 文档 (Markdown)</option>
                        <option value="code">💻 代码段 (Code)</option>
                        <option value="color">🎨 色卡 (Palette)</option>
                        <option value="audio">🎤 音频 (Audio)</option>
                        <option value="link">🔗 链接 (Link)</option>
                    </select>
                    <span class="select-arrow">▼</span>
                </div>
            </div>

            <div class="form-group">
                <label class="panel-label">存储位置</label>
                <div class="select-wrapper">
                    <select id="resParentId" class="form-input panel-select">
                        <option value="">(根目录)</option>
                    </select>
                    <span class="select-arrow">▼</span>
                </div>
            </div>

            <div class="form-group">
                <label class="panel-label">资源名称</label>
                <input type="text" id="resName" class="form-input panel-input" placeholder="给它起个名字...">
            </div>

            <!-- 动态内容区域 -->
            <div class="form-group dynamic-input" id="groupFile">
                <label class="panel-label" id="fileLabel">选择文件</label>
                <input type="file" id="resFile" class="form-input panel-input" style="padding: 8px;">
            </div>

            <div class="form-group dynamic-input" id="groupText" style="display: none;">
                <label class="panel-label" id="textLabel">内容</label>
                <input type="text" id="resTextInput" class="form-input panel-input" style="display:none;" placeholder="输入链接地址...">
                <textarea id="resTextArea" class="form-input panel-input" rows="8" style="font-family: monospace; line-height: 1.5;" placeholder="# Markdown Title..."></textarea>
            </div>

            <div class="form-group dynamic-input" id="groupColor" style="display: none;">
                <label class="panel-label">选择颜色</label>
                <div style="display:flex; align-items:center; gap:12px; background: var(--bg-app); padding: 8px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <input type="color" id="resColorInput" style="width:40px; height:40px; border:none; padding:0; cursor: pointer; border-radius: 4px;">
                    <span id="resColorValue" style="font-family:monospace; font-weight:bold; font-size: 16px;">#000000</span>
                </div>
            </div>
        </div>

        <div class="panel-footer">
            <button class="btn-secondary" onclick="app.ui.closeModal('resModal')">取消</button>
            <button class="btn-primary" onclick="app.ui.handleSaveResourceClick()">保存资源</button>
        </div>
    </div>
</div>

<div class="node-menu modern-panel" id="nodeMenu" style="display: none;">
    <div class="panel-header">
        <h3>✨ 编辑节点</h3>
        <button class="close-btn" onclick="document.getElementById('nodeMenu').style.display='none'">×</button>
    </div>

    <div class="panel-body">
        <div class="form-group">
            <label class="panel-label">节点名称</label>
            <label for="nodeLabel"></label><input type="text" id="nodeLabel" class="form-input panel-input" placeholder="输入节点标题...">
        </div>

        <div class="form-group">
            <label class="panel-label">关联资源</label>
            <div class="select-wrapper">
                <label for="nodeResSelect"></label><select id="nodeResSelect" class="form-input panel-select"></select>
                <span class="select-arrow">▼</span>
            </div>
            <small class="panel-hint">关联后，悬浮节点即可预览内容</small>
        </div>
    </div>

    <div class="panel-footer">
        <button class="btn-primary full-width" onclick="app.ui.handleSaveNodeEdit()">保存修改</button>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
    if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('closed');
    else document.getElementById('sidebar').classList.remove('closed');

    if(localStorage.getItem('theme') === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
    }

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                refreshing = true;
                window.location.reload();
            });
            navigator.serviceWorker.register('sw.js')
                .then(registration => { console.log('SW Registered:', registration.scope); })
                .catch(err => { console.log('SW Registration Failed:', err); });
        });
    }
</script>
</body>
</html>
